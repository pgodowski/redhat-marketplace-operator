# Generated by internal/ci/ci_tool.cue; do not edit

name: Publish
on:
- issue_comment
jobs:
  publish:
    name: Publish Images
    runs-on: ubuntu-20.04
    defaults:
      run:
        shell: bash
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body,
      '/publish') }}
    steps:
    - name: Check if user has write access
      uses: lannonbr/repo-permission-check-action@2.0.0
      with:
        permission: write
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - id: pr
      name: Get PR for Comment
      run: |-
        PR=$(curl -H "Accept: application/vnd.github.v3+json" \
             "${GITHUB_API_URL}/repos/${GITHUB_REPOSITORY}/pulls/${{ github.event.issue.number }}" )
        echo "::set-output name=prSha::$(echo $PR | jq ".head.sha")"
        echo "::set-output name=prRef::$(echo $PR | jq ".head.ref")"
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        sha: ${{ steps.pr.outputs.prSha }}
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15.11
    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: ${{ runner.os }}-1.15.11-go-
    - name: Install Kubebuilder
      run: |-
        os=$(go env GOOS)
        arch=$(go env GOARCH)

        # download kubebuilder and extract it to tmp
        curl -L https://go.kubebuilder.io/dl/2.3.1/${os}/${arch} | tar -xz -C /tmp/

        # move to a long-term location and put it on your path
        # (you'll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)
        sudo mv /tmp/kubebuilder_2.3.1_${os}_${arch} /usr/local/kubebuilder
        echo "/usr/local/kubebuilder/bin" >> $GITHUB_PATH
    - name: Install operatorsdk
      run: |-
        export ARCH=$(case $(arch) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(arch) ;; esac)
        export OS=$(uname | awk '{print tolower($0)}')
        export OPERATOR_SDK_DL_URL=https://github.com/operator-framework/operator-sdk/releases/latest/download
        curl -LO ${OPERATOR_SDK_DL_URL}/operator-sdk_${OS}_${ARCH}
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt.asc
        grep operator-sdk_${OS}_${ARCH} checksums.txt | sha256sum -c -
        chmod +x operator-sdk_${OS}_${ARCH} && sudo mv operator-sdk_${OS}_${ARCH} /usr/local/bin/operator-sdk
        curl -LO https://github.com/operator-framework/operator-registry/releases/download/v1.15.3/${OS}-${ARCH}-opm
        chmod +x ${OS}-${ARCH}-opm && sudo mv ${OS}-${ARCH}-opm /usr/local/bin/opm
    - id: version
      name: Get Version
      run: |-
        make svu
        export VERSION="$(./bin/svu next)"

        if [ "$REF" == "" ]; then
        	REF="$GITHUB_REF"
        fi

        if [[ "$GITHUB_HEAD_REF" != "" ]]; then
        	echo "Request is a PR $GITHUB_HEAD_REF is head; is base $GITHUB_BASE_REF is base"
          REF="$GITHUB_HEAD_REF"
        fi

        echo "Found ref $REF"

        if [[ "$VERSION" == "" ]]; then
          echo "failed to find version"
          exit 1
        fi

        if [[ "$REF" == *"release"* ||  "$REF" == *"hotfix"* ]] ; then
        echo "using release version and github_run_number"
        export TAG="${VERSION}-${GITHUB_RUN_NUMBER}"
        export IS_DEV="false"
        else
        echo "using beta in version"
        export TAG="${VERSION}-beta-${GITHUB_RUN_NUMBER}"
        export IS_DEV="true"
        fi

        echo "Found version $VERSION"
        echo "::set-output name=version::$VERSION"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Found tag $TAG"
        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "::set-output name=tag::$TAG"
        echo "IS_DEV=$IS_DEV" >> $GITHUB_ENV
        echo "::set-output name=isDev::$IS_DEV"
        echo "REF=$REF" >> $GITHUB_ENV
      env:
        REF: ${{ steps.pr.outputs.prRef }}
    - name: Get Latest Bundle Run
      run: |-
        WORKFLOW_ID=8480641
        BRANCH_BUILD=$(curl \
          -H "Accept: application/vnd.github.v3+json" \
          "${GITHUB_API_URL}/repos/${GITHUB_REPOSITORY}/actions/workflows/$WORKFLOW_ID/runs?branch=$REF&event=push" \
           | jq '.workflow_runs | max_by(.run_number)')

        if [ "$BRANCH_BUILD" == "" ]; then
          echo "failed to get branch build"
          exit 1
        fi

        status=$(echo $BRANCH_BUILD | jq -r '.status')
        conclusion=$(echo $BRANCH_BUILD | jq -r '.conclusion')

        if [ "$status" != "completed" ] && [ "$conclusion" != "success" ]; then
          echo "$status and $conclusion were not completed and successful"
          exit 1
        fi

        RUN_NUMBER=$(echo $BRANCH_BUILD | jq -r '.run_number')

        export TAG="${VERSION}-${RUN_NUMBER}"
        echo "setting tag to $TAG"
        echo "TAG=$TAG" >> $GITHUB_ENV
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        registry: registry.connect.redhat.com
        username: ${{secrets['REDHAT_IO_USER']}}
        password: ${{secrets['REDHAT_IO_PASSWORD']}}
    - name: Publish Operator Images
      run: |-
        make pc-tool
        export IMAGES=""
        ## getting image shas redhat-marketplace-operator
        shas=($(docker manifest inspect quay.io/rh-marketplace/redhat-marketplace-operator:$TAG | jq -r '.manifests[].digest' | xargs))
        for sha in "${shas}"
        do
        export IMAGES="--images https://connect.redhat.com/projects/5e98b6fac77ce6fca8ac859c/images,${sha},$TAG $IMAGES"
        done

        ## getting image shas redhat-marketplace-metric-state
        shas=($(docker manifest inspect quay.io/rh-marketplace/redhat-marketplace-metric-state:$TAG | jq -r '.manifests[].digest' | xargs))
        for sha in "${shas}"
        do
        export IMAGES="--images https://connect.redhat.com/projects/5f36ea2f74cc50b8f01a838d/images,${sha},$TAG $IMAGES"
        done

        ## getting image shas redhat-marketplace-reporter
        shas=($(docker manifest inspect quay.io/rh-marketplace/redhat-marketplace-reporter:$TAG | jq -r '.manifests[].digest' | xargs))
        for sha in "${shas}"
        do
        export IMAGES="--images https://connect.redhat.com/projects/5e98b6fc32116b90fd024d06/images,${sha},$TAG $IMAGES"
        done

        ## getting image shas redhat-marketplace-authcheck
        shas=($(docker manifest inspect quay.io/rh-marketplace/redhat-marketplace-authcheck:$TAG | jq -r '.manifests[].digest' | xargs))
        for sha in "${shas}"
        do
        export IMAGES="--images https://connect.redhat.com/projects/5f62b71018e80cdc21edf22f/images,${sha},$TAG $IMAGES"
        done
        echo "publishing $IMAGES"
        ./bin/partner-connect-tool publish $IMAGES
      env:
        RH_USER: ${{ secrets['REDHAT_IO_USER'] }}
        RH_PASSWORD: ${{ secrets['REDHAT_IO_PASSWORD'] }}
        RH_CONNECT_TOKEN: ${{ secrets.redhat_api_key }}
      continue-on-error: true
    - name: Copy Manifest
      run: |-
        echo "::group::Push scan.connect.redhat.com/ospid-64f06656-d9d4-43ef-a227-3b9c198800a1/redhat-marketplace-operator-manifest:$TAG"
        skopeo --override-os=linux inspect docker://scan.connect.redhat.com/ospid-64f06656-d9d4-43ef-a227-3b9c198800a1/redhat-marketplace-operator-manifest:$TAG --creds ${{secrets['pcUser']}}:${{secrets['pcPasswordOperatorManifest']}} > /dev/null
        ([[ $? == 0 ]] && echo "exists=true" || skopeo copy docker://quay.io/rh-marketplace/redhat-marketplace-operator-manifest:$TAG docker://scan.connect.redhat.com/ospid-64f06656-d9d4-43ef-a227-3b9c198800a1/redhat-marketplace-operator-manifest:$TAG --dest-creds ${{secrets['pcUser']}}:${{secrets['pcPasswordOperatorManifest']}})
        echo "::endgroup::"
      shell: bash {0}
  publish-operator:
    name: Publish Operator
    runs-on: ubuntu-20.04
    env:
      REF: ${{ github.event.issue.pull_request[0].head.ref }}
    defaults:
      run:
        shell: bash
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body,
      '/publish-operator') }}
    steps:
    - name: Check if user has write access
      uses: lannonbr/repo-permission-check-action@2.0.0
      with:
        permission: write
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - id: pr
      name: Get PR for Comment
      run: |-
        PR=$(curl -H "Accept: application/vnd.github.v3+json" \
             "${GITHUB_API_URL}/repos/${GITHUB_REPOSITORY}/pulls/${{ github.event.issue.number }}" )
        echo "::set-output name=prSha::$(echo $PR | jq ".head.sha")"
        echo "::set-output name=prRef::$(echo $PR | jq ".head.ref")"
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        sha: ${{ steps.pr.outputs.prSha }}
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15.11
    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: ${{ runner.os }}-1.15.11-go-
    - name: Install Kubebuilder
      run: |-
        os=$(go env GOOS)
        arch=$(go env GOARCH)

        # download kubebuilder and extract it to tmp
        curl -L https://go.kubebuilder.io/dl/2.3.1/${os}/${arch} | tar -xz -C /tmp/

        # move to a long-term location and put it on your path
        # (you'll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)
        sudo mv /tmp/kubebuilder_2.3.1_${os}_${arch} /usr/local/kubebuilder
        echo "/usr/local/kubebuilder/bin" >> $GITHUB_PATH
    - name: Install operatorsdk
      run: |-
        export ARCH=$(case $(arch) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(arch) ;; esac)
        export OS=$(uname | awk '{print tolower($0)}')
        export OPERATOR_SDK_DL_URL=https://github.com/operator-framework/operator-sdk/releases/latest/download
        curl -LO ${OPERATOR_SDK_DL_URL}/operator-sdk_${OS}_${ARCH}
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt.asc
        grep operator-sdk_${OS}_${ARCH} checksums.txt | sha256sum -c -
        chmod +x operator-sdk_${OS}_${ARCH} && sudo mv operator-sdk_${OS}_${ARCH} /usr/local/bin/operator-sdk
        curl -LO https://github.com/operator-framework/operator-registry/releases/download/v1.15.3/${OS}-${ARCH}-opm
        chmod +x ${OS}-${ARCH}-opm && sudo mv ${OS}-${ARCH}-opm /usr/local/bin/opm
    - id: version
      name: Get Version
      run: |-
        make svu
        export VERSION="$(./bin/svu next)"

        if [ "$REF" == "" ]; then
        	REF="$GITHUB_REF"
        fi

        if [[ "$GITHUB_HEAD_REF" != "" ]]; then
        	echo "Request is a PR $GITHUB_HEAD_REF is head; is base $GITHUB_BASE_REF is base"
          REF="$GITHUB_HEAD_REF"
        fi

        echo "Found ref $REF"

        if [[ "$VERSION" == "" ]]; then
          echo "failed to find version"
          exit 1
        fi

        if [[ "$REF" == *"release"* ||  "$REF" == *"hotfix"* ]] ; then
        echo "using release version and github_run_number"
        export TAG="${VERSION}-${GITHUB_RUN_NUMBER}"
        export IS_DEV="false"
        else
        echo "using beta in version"
        export TAG="${VERSION}-beta-${GITHUB_RUN_NUMBER}"
        export IS_DEV="true"
        fi

        echo "Found version $VERSION"
        echo "::set-output name=version::$VERSION"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Found tag $TAG"
        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "::set-output name=tag::$TAG"
        echo "IS_DEV=$IS_DEV" >> $GITHUB_ENV
        echo "::set-output name=isDev::$IS_DEV"
        echo "REF=$REF" >> $GITHUB_ENV
      env:
        REF: ${{ steps.pr.outputs.prRef }}
    - name: Get Latest Bundle Run
      run: |-
        WORKFLOW_ID=8480641
        BRANCH_BUILD=$(curl \
          -H "Accept: application/vnd.github.v3+json" \
          "${GITHUB_API_URL}/repos/${GITHUB_REPOSITORY}/actions/workflows/$WORKFLOW_ID/runs?branch=$REF&event=push" \
           | jq '.workflow_runs | max_by(.run_number)')

        if [ "$BRANCH_BUILD" == "" ]; then
          echo "failed to get branch build"
          exit 1
        fi

        status=$(echo $BRANCH_BUILD | jq -r '.status')
        conclusion=$(echo $BRANCH_BUILD | jq -r '.conclusion')

        if [ "$status" != "completed" ] && [ "$conclusion" != "success" ]; then
          echo "$status and $conclusion were not completed and successful"
          exit 1
        fi

        RUN_NUMBER=$(echo $BRANCH_BUILD | jq -r '.run_number')

        export TAG="${VERSION}-${RUN_NUMBER}"
        echo "setting tag to $TAG"
        echo "TAG=$TAG" >> $GITHUB_ENV
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        registry: registry.connect.redhat.com
        username: ${{secrets['REDHAT_IO_USER']}}
        password: ${{secrets['REDHAT_IO_PASSWORD']}}
    - name: Publish Operator
      run: |-
        make pc-tool
        ./bin/partner-connect-tool publish --is-operator-manifest=true --images https://connect.redhat.com/projects/5f68c9457115dbd1183ccab6/images,,$TAG-cert
      env:
        RH_USER: ${{ secrets['REDHAT_IO_USER'] }}
        RH_PASSWORD: ${{ secrets['REDHAT_IO_PASSWORD'] }}
        RH_CONNECT_TOKEN: ${{ secrets.redhat_api_key }}
