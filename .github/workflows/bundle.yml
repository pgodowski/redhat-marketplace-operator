# Generated by internal/ci/ci_tool.cue; do not edit

name: Deploy Bundle
on:
  repository_dispatch:
    types:
    - bundle
env:
  IMAGE_REGISTRY: quay.io/rh-marketplace
  BRANCH: ${{github.event.client_payload.branch}}
  DEPLOY_SHA: ${{github.event.client_payload.sha}}
  IS_PR: ${{github.event.client_payload.pull_request}}
jobs:
  deploy:
    name: Deploy Bundle
    runs-on: ubuntu-20.04
    outputs:
      version: ${{ steps.bundle.outputs.version }}
      tag: ${{ steps.bundle.outputs.tag }}
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        ref: ${{github.event.client_payload.sha}}
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15.6
    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: ${{ runner.os }}-1.15.6-go-
    - name: Install operatorsdk
      run: |-
        export ARCH=$(case $(arch) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(arch) ;; esac)
        export OS=$(uname | awk '{print tolower($0)}')
        export OPERATOR_SDK_DL_URL=https://github.com/operator-framework/operator-sdk/releases/latest/download
        curl -LO ${OPERATOR_SDK_DL_URL}/operator-sdk_${OS}_${ARCH}
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt.asc
        grep operator-sdk_${OS}_${ARCH} checksums.txt | sha256sum -c -
        chmod +x operator-sdk_${OS}_${ARCH} && sudo mv operator-sdk_${OS}_${ARCH} /usr/local/bin/operator-sdk
        curl -LO https://github.com/operator-framework/operator-registry/releases/download/v1.15.3/${OS}-${ARCH}-opm
        chmod +x ${OS}-${ARCH}-opm && sudo mv ${OS}-${ARCH}-opm /usr/local/bin/opm
    - name: Install YQ
      run: sudo snap install yq
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        registry: quay.io/rh-marketplace
        username: ${{secrets['quayUser']}}
        password: ${{secrets['quayPassword']}}
    - id: bundle
      name: Build bundle
      run: |-
        if [ "$IS_PR" == "false" ] && [ "$BRANCH" != "" ] ; then
        echo "is a dev request"
        export IS_DEV="true"
        else
        echo "is a release request"
        export IS_DEV="false"
        fi

        cd v2
        export VERSION=$(cd ./tools/version && go run ./main.go)
        export TAG=${VERSION}-${DEPLOY_SHA}-amd64

        echo "::group::Make Stable Bundle"
        make bundle-stable
        echo "::endgroup::"

        if [ "$IS_DEV" == "true" ] ; then
        echo "using branch in version"
        export VERSION="${VERSION}-${BRANCH}-${GITHUB_RUN_NUMBER}"
        else
        echo "using release version and githb_run_number"
        export VERSION="${VERSION}-${GITHUB_RUN_NUMBER}"
        fi

        echo "::group::Make Bundle Build"
        make bundle-build
        echo "::endgroup::"
        echo "::group::Make Deploy"
        make bundle-deploy
        echo "::endgroup::"
        echo "::group::Make Dev Index"
        make bundle-dev-index
        echo "::endgroup::"

        echo "::set-output name=version::$VERSION"
        echo "::set-output name=tag::$TAG"
  publish:
    name: Publish Images
    needs:
    - deploy
    runs-on: ubuntu-20.04
    env:
      VERSION: ${{ needs.deploy.outputs.version }}
      TAG: ${{ needs.deploy.outputs.tag }}
    defaults:
      run:
        shell: bash
    if: github.event.client_payload.pull_request != 'false'
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        ref: ${{github.event.client_payload.sha}}
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15.6
    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: ${{ runner.os }}-1.15.6-go-
    - name: Install operatorsdk
      run: |-
        export ARCH=$(case $(arch) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(arch) ;; esac)
        export OS=$(uname | awk '{print tolower($0)}')
        export OPERATOR_SDK_DL_URL=https://github.com/operator-framework/operator-sdk/releases/latest/download
        curl -LO ${OPERATOR_SDK_DL_URL}/operator-sdk_${OS}_${ARCH}
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt
        curl -LO ${OPERATOR_SDK_DL_URL}/checksums.txt.asc
        grep operator-sdk_${OS}_${ARCH} checksums.txt | sha256sum -c -
        chmod +x operator-sdk_${OS}_${ARCH} && sudo mv operator-sdk_${OS}_${ARCH} /usr/local/bin/operator-sdk
        curl -LO https://github.com/operator-framework/operator-registry/releases/download/v1.15.3/${OS}-${ARCH}-opm
        chmod +x ${OS}-${ARCH}-opm && sudo mv ${OS}-${ARCH}-opm /usr/local/bin/opm
    - id: mirror
      name: Mirror images
      run: |-
        echo "::group::Push scan.connect.redhat.com/ospid-c93f69b6-cb04-437b-89d6-e5220ce643cd/redhat-marketplace-operator:$TAG"
        skopeo inspect docker://scan.connect.redhat.com/ospid-c93f69b6-cb04-437b-89d6-e5220ce643cd/redhat-marketplace-operator:$TAG --creds ${{secrets['pcUser']}}:${{secrets['pcPassword']}} > /dev/null
        ([[ $? == 0 ]] && echo "exists=true" || skopeo copy --all docker://quay.io/rh-marketplace/redhat-marketplace-operator:$TAG docker://scan.connect.redhat.com/ospid-c93f69b6-cb04-437b-89d6-e5220ce643cd/redhat-marketplace-operator:$TAG --dest-creds ${{secrets['pcUser']}}:${{secrets['pcPassword']}})
        echo "::endgroup::"
        echo "::group::Push scan.connect.redhat.com/ospid-9b9b0dbe-7adc-448e-9385-a556714a09c4/redhat-marketplace-metric-state:$TAG"
        skopeo inspect docker://scan.connect.redhat.com/ospid-9b9b0dbe-7adc-448e-9385-a556714a09c4/redhat-marketplace-metric-state:$TAG --creds ${{secrets['pcUser']}}:${{secrets['pcPasswordMetricState']}} > /dev/null
        ([[ $? == 0 ]] && echo "exists=true" || skopeo copy --all docker://quay.io/rh-marketplace/redhat-marketplace-metric-state:$TAG docker://scan.connect.redhat.com/ospid-9b9b0dbe-7adc-448e-9385-a556714a09c4/redhat-marketplace-metric-state:$TAG --dest-creds ${{secrets['pcUser']}}:${{secrets['pcPasswordMetricState']}})
        echo "::endgroup::"
        echo "::group::Push scan.connect.redhat.com/ospid-faa0f295-e195-4bcc-a3fc-a4b97ada317e/redhat-marketplace-reporter:$TAG"
        skopeo inspect docker://scan.connect.redhat.com/ospid-faa0f295-e195-4bcc-a3fc-a4b97ada317e/redhat-marketplace-reporter:$TAG --creds ${{secrets['pcUser']}}:${{secrets['pcPasswordReporter']}} > /dev/null
        ([[ $? == 0 ]] && echo "exists=true" || skopeo copy --all docker://quay.io/rh-marketplace/redhat-marketplace-reporter:$TAG docker://scan.connect.redhat.com/ospid-faa0f295-e195-4bcc-a3fc-a4b97ada317e/redhat-marketplace-reporter:$TAG --dest-creds ${{secrets['pcUser']}}:${{secrets['pcPasswordReporter']}})
        echo "::endgroup::"
        echo "::group::Push scan.connect.redhat.com/ospid-ffed416e-c18d-4b88-8660-f586a4792785/redhat-marketplace-authcheck:$TAG"
        skopeo inspect docker://scan.connect.redhat.com/ospid-ffed416e-c18d-4b88-8660-f586a4792785/redhat-marketplace-authcheck:$TAG --creds ${{secrets['pcUser']}}:${{secrets['pcPasswordAuthCheck']}} > /dev/null
        ([[ $? == 0 ]] && echo "exists=true" || skopeo copy --all docker://quay.io/rh-marketplace/redhat-marketplace-authcheck:$TAG docker://scan.connect.redhat.com/ospid-ffed416e-c18d-4b88-8660-f586a4792785/redhat-marketplace-authcheck:$TAG --dest-creds ${{secrets['pcUser']}}:${{secrets['pcPasswordAuthCheck']}})
        echo "::endgroup::"
      shell: bash {0}
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        registry: registry.connect.redhat.com
        username: ${{secrets['REDHAT_IO_USER']}}
        password: ${{secrets['REDHAT_IO_PASSWORD']}}
    - name: Wait for RH publish
      run: |-
        cd v2
        make wait-and-publish PIDS="--pid ospid-c93f69b6-cb04-437b-89d6-e5220ce643cd=$(skopeo inspect --override-os=linux --format "{{.Digest}}" docker://quay.io/rh-marketplace/redhat-marketplace-operator:$TAG) --pid ospid-9b9b0dbe-7adc-448e-9385-a556714a09c4=$(skopeo inspect --override-os=linux --format "{{.Digest}}" docker://quay.io/rh-marketplace/redhat-marketplace-metric-state:$TAG) --pid ospid-faa0f295-e195-4bcc-a3fc-a4b97ada317e=$(skopeo inspect --override-os=linux --format "{{.Digest}}" docker://quay.io/rh-marketplace/redhat-marketplace-reporter:$TAG) --pid ospid-ffed416e-c18d-4b88-8660-f586a4792785=$(skopeo inspect --override-os=linux --format "{{.Digest}}" docker://quay.io/rh-marketplace/redhat-marketplace-authcheck:$TAG)"
      env:
        RH_CONNECT_TOKEN: ${{ secrets.redhat_api_key }}
      continue-on-error: true
    - name: Copy Manifest
      run: |-
        echo "::group::Push scan.connect.redhat.com/ospid-64f06656-d9d4-43ef-a227-3b9c198800a1/redhat-marketplace-operator-manifest:$VERSION"
        skopeo inspect docker://scan.connect.redhat.com/ospid-64f06656-d9d4-43ef-a227-3b9c198800a1/redhat-marketplace-operator-manifest:$VERSION --creds ${{secrets['pcUser']}}:${{secrets['pcPasswordOperatorManifest']}} > /dev/null
        ([[ $? == 0 ]] && echo "exists=true" || skopeo copy --all docker://quay.io/rh-marketplace/redhat-marketplace-operator-manifest:$VERSION docker://scan.connect.redhat.com/ospid-64f06656-d9d4-43ef-a227-3b9c198800a1/redhat-marketplace-operator-manifest:$VERSION --dest-creds ${{secrets['pcUser']}}:${{secrets['pcPasswordOperatorManifest']}})
        echo "::endgroup::"
      shell: bash {0}
      env:
        TAG: ${{ steps.deploy.outputs.version }}
